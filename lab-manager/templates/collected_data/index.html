{% extends "base.html" %}
{% block content %}
<style>
    .nowrap { white-space: nowrap; }
    .truncate { max-width: 360px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle; }
    .mono { font-family: monospace; }
    .import-form { display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end; margin-bottom: 16px; }
    .import-form label { display: flex; flex-direction: column; font-weight: 600; color: #111827; font-size: 0.95rem; }
    .import-form input,
    .import-form select { padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; min-width: 200px; }
    .import-form button { padding: 8px 14px; border: none; border-radius: 6px; background: #2563eb; color: white; font-weight: 600; cursor: pointer; }
    .import-form button:hover { background: #1d4ed8; }
    .actions-row { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 12px; align-items: flex-end; }
    .correction-card { background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
    .correction-card h3 { margin: 0 0 8px 0; }
    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.4); border-top-color: #fff; border-radius: 50%; margin-right: 8px; vertical-align: middle; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
<div class="card">
    <div style="display:flex; justify-content: space-between; align-items:center; gap: 12px; flex-wrap: wrap;">
        <h2 style="margin: 0;">Dados coletados</h2>
        <span style="color: #4b5563; font-size: 0.95rem;">Mostrando últimos {{ rows|length }} registros (ordem decrescente por ID).</span>
    </div>

    <div class="actions-row">
        <form class="import-form" action="{{ url_for('import_collected_data') }}" method="POST" enctype="multipart/form-data">
            <label>
                Arquivo CSV
                <input type="file" name="data_file" accept=".csv" required>
            </label>
            <label>
                Experimento
                <select name="experiment_id" required>
                    <option value="">Selecione</option>
                    {% for exp in experiments %}
                        <option value="{{ exp.id }}">{{ exp.experiment_name }} (ID {{ exp.id }})</option>
                    {% endfor %}
                </select>
            </label>
            <button type="submit">Importar dados</button>
        </form>

        <form class="import-form" action="{{ url_for('collected_data_correction') }}" method="POST">
            <label>
                Experimento para correção
                <select name="experiment_id" required>
                    <option value="">Selecione</option>
                    {% for exp in experiments %}
                        <option value="{{ exp.id }}">{{ exp.experiment_name }} (ID {{ exp.id }})</option>
                    {% endfor %}
                </select>
            </label>
            <button type="submit" id="auto-correction-submit">Correção Automática</button>
        </form>
    </div>

    {% if correction_result %}
    <div class="correction-card">
        <h3>Correção automática</h3>
        <pre style="white-space: pre-wrap; word-break: break-word; margin: 0;">{{ correction_result }}</pre>
    </div>
    {% endif %}

    {% if rows %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Experimento</th>
                <th>Exp. ID</th>
                <th>Step</th>
                <th>Pulse train</th>
                <th>Pulse value</th>
                <th>Time to change</th>
                <th>Duração</th>
                <th>Timestamp</th>
            </tr>
        </thead>
        <tbody>
            {% for row in rows %}
            <tr>
                <td class="nowrap">{{ row.id }}</td>
                <td>{{ row.experimentName or '' }}</td>
                <td class="nowrap">{{ row.experiment_id }}</td>
                <td class="mono truncate" title="{{ row.step }}">{{ row.step }}</td>
                <td class="mono truncate" title="{{ row.pulse_train }}">{{ row.pulse_train }}</td>
                <td class="nowrap">{{ row.pulse_value }}</td>
                <td class="nowrap">{{ row.timeToChange }}</td>
                <td class="nowrap">{{ row.duration or '-' }}</td>
                <td class="nowrap">{{ row.time_stamp or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>Nenhum dado coletado encontrado.</p>
    {% endif %}
</div>
<script>
    (function() {
        const form = document.querySelector('form[action="{{ url_for('collected_data_correction') }}"]');
        if (!form) return;
        const submitBtn = form.querySelector('#auto-correction-submit');
        form.addEventListener('submit', function(ev) {
            if (!submitBtn || submitBtn.dataset.submitting === "1") {
                ev.preventDefault();
                return;
            }
            submitBtn.dataset.submitting = "1";
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner" aria-hidden="true"></span>Processando...';
        });
    })();
</script>
{% endblock %}
