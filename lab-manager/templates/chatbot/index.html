{% extends "base.html" %}

{% block content %}
<style>
    .chat-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; align-items: start; }
    .chat-card { background: #fff; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .chat-log { height: 420px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px; background: #f9fafb; display: flex; flex-direction: column; gap: 10px; }
    .bubble { padding: 10px 12px; border-radius: 10px; max-width: 86%; width: fit-content; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
    .bubble.human { background: #2563eb; color: #fff; margin-left: auto; }
    .bubble.ai { background: #e5e7eb; color: #111827; }
    .bubble.system { background: #fef3c7; color: #92400e; }
    .chat-actions { margin-top: 12px; display: flex; gap: 10px; align-items: center; }
    #chat-input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-family: inherit; resize: vertical; min-height: 80px; }
    .badge { display: inline-block; padding: 4px 8px; border-radius: 9999px; font-size: 0.8rem; }
    .badge.ok { background: #dcfce7; color: #166534; }
    .badge.warn { background: #fef9c3; color: #854d0e; }
    .help-card { background: #f9fafb; border: 1px dashed #d1d5db; border-radius: 8px; padding: 14px; }
    .error-box { display: none; margin-top: 10px; padding: 10px; border-radius: 6px; background: #fee2e2; color: #7f1d1d; }
    @media (max-width: 900px) { .chat-layout { grid-template-columns: 1fr; } }
</style>

<div class="chat-layout">
    <div class="chat-card">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap;">
            <h2 style="margin: 0;">Chatbot</h2>
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                <span class="badge {{ 'ok' if openai_ready else 'warn' }}">{{ 'OPENAI_API_KEY ok' if openai_ready else 'Defina OPENAI_API_KEY' }}</span>
                <span class="badge ok">API {{ api_base }}</span>
            </div>
        </div>
        <p style="margin-top: 4px; color: #4b5563;">Converse com o agente para listar, criar ou remover experimentos e padrões. A conversa usa as ferramentas expostas pela API.</p>
        {% if not openai_ready %}
            <div class="error-box" style="display: block; background: #fef9c3; color: #854d0e; border: 1px solid #fcd34d;">Defina a variável de ambiente OPENAI_API_KEY antes de enviar mensagens.</div>
        {% endif %}
        <div class="chat-log" id="chat-log">
            <div class="bubble system">Pronto para conversar. Envie perguntas como "listar experimentos" ou "criar experimento demo".</div>
        </div>
        <form id="chat-form" class="chat-actions">
            <textarea id="chat-input" placeholder="Digite sua mensagem..." required></textarea>
            <div style="display: flex; gap: 8px; flex-direction: column; min-width: 140px;">
                <button type="submit" id="send-btn">Enviar</button>
                <button type="button" class="secondary" id="clear-btn">Limpar histórico</button>
            </div>
        </form>
        <div id="chat-error" class="error-box"></div>
    </div>
    <div class="help-card">
        <h3 style="margin-top: 0;">Dicas</h3>
        <ul style="padding-left: 18px; margin: 0 0 8px 0; color: #4b5563;">
            <li>Certifique-se de que o Flask esteja rodando (porta 5001 por padrão).</li>
            <li>O chatbot conversa com as rotas REST (`/api/experiments`, `/api/ground-truth`).</li>
            <li>Mantenha a aba aberta para preservar o histórico da sessão.</li>
            <li>Exemplos: “listar experimentos”, “criar experimento teste ip 10.0.0.5” ou “mostrar padrões do professor”.</li>
        </ul>
    </div>
</div>

<script>
    const chatLog = document.getElementById('chat-log');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatError = document.getElementById('chat-error');
    const sendBtn = document.getElementById('send-btn');
    const clearBtn = document.getElementById('clear-btn');
    let history = [];

    const renderHistory = () => {
        chatLog.innerHTML = '';
        if (!history.length) {
            const bubble = document.createElement('div');
            bubble.className = 'bubble system';
            bubble.textContent = 'Pronto para conversar. Envie perguntas como "listar experimentos" ou "criar experimento demo".';
            chatLog.appendChild(bubble);
            return;
        }
        history.forEach(msg => {
            if (!msg || !msg.type) return;
            if (!['human', 'ai', 'system'].includes(msg.type)) return;
            const content = formatContent(msg.data && msg.data.content);
            const bubble = document.createElement('div');
            bubble.className = `bubble ${msg.type}`;
            bubble.textContent = content || '';
            chatLog.appendChild(bubble);
        });
        chatLog.scrollTop = chatLog.scrollHeight;
    };

    const formatContent = (value) => {
        if (value === null || value === undefined) return '';
        if (typeof value === 'string') return value;
        try { return JSON.stringify(value, null, 2); } catch { return String(value); }
    };

    const setError = (text) => {
        if (!text) {
            chatError.style.display = 'none';
            chatError.textContent = '';
            return;
        }
        chatError.style.display = 'block';
        chatError.textContent = text;
    };

    const setLoading = (loading) => {
        sendBtn.disabled = loading;
        sendBtn.textContent = loading ? 'Enviando...' : 'Enviar';
    };

    chatForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        setError('');
        const message = chatInput.value.trim();
        if (!message) return;
        setLoading(true);
        try {
            const response = await fetch('{{ url_for("chatbot_ask") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message, history }),
            });
            if (!response.ok) {
                const text = await response.text();
                throw new Error(text || 'Erro ao enviar mensagem.');
            }
            const data = await response.json();
            history = data.history || [];
            renderHistory();
            chatInput.value = '';
            if (data.reply) {
                chatInput.placeholder = 'Pergunte algo mais...';
            }
        } catch (err) {
            setError(err.message || 'Erro inesperado.');
        } finally {
            setLoading(false);
            chatInput.focus();
        }
    });

    clearBtn.addEventListener('click', () => {
        history = [];
        renderHistory();
        chatInput.value = '';
        setError('');
    });
</script>
{% endblock %}
